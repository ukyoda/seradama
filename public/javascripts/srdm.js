!function(a){var b="srdm",c={};a.util=c,c.getSprite=function(a){return PIXI.TextureCache[a]?new PIXI.Sprite.fromFrame(a):new PIXI.Sprite.fromImage(a)};var d=function(a){this.deferred=$.Deferred(),this.src=a;var b=this;this.src.addEventListener("ended",function(){b.deferred.resolve(b)})};d.fn=d.prototype,d.fn.play=function(){return this.src.play(),this},d.fn.stop=function(){return this.src.pause(),this.src.load(),this},d.fn.pause=function(){return this.src.pause(),this},d.fn.mute=function(){this.src.muted=this.src.muted?!1:!0};var e=function(){this.deferred=$.Deferred()};e.fn=e.prototype,e.fn.setRankimg=function(a){return 1==a?"gold":2==a?"silver":3==a?"blonze":""},e.fn.createLayout=function(){var a=$("<div/>");return $("<div/>").addClass("content").appendTo(a),a.addClass("alert")},e.fn.createGoalAlert=function(a){var b=this.createLayout(),c=b.find(".content"),d=$("<div/>").appendTo(c),e=a.name||a.id;return d.text("@"+e+" さんがクリアしました"),b},e.fn.createRankingAlert=function(a){var b=this.createLayout(),c=b.find(".content");$("<div/>").text("★ランキング★").appendTo(c);var d=$("<ul/>").addClass("ranking").appendTo(c),f=function(a,b){var c=$("<div/>");return c.addClass("grid name"),$("<img/>").attr("src",b).appendTo(c),$("<span>").text("@"+a).appendTo(c),c};return $.each(a,function(a,b){var c=b.rank,g=b.data.win,h=b.sprite.name||b.sprite.id,i=b.sprite.img||"http://127.0.0.1/images/favicon.ico",j=$("<li/>");$("<div/>").addClass("grid rank").addClass(e.fn.setRankimg(c)).text(c).appendTo(j),f(h,i).appendTo(j),$("<div/>").addClass("grid-right count").text(g).appendTo(j),d.append(j)}),b},e.fn.createYourRankAlert=function(a,b){var c=this.createLayout(),d=c.find(".content"),e=a.sprite.name||a.sprite.id,f=a.sprite.img||"http://127.0.0.1/images/favicon.ico",g=a.rank,h=a.data.win,i=h-b;$("<div/>").text("★あなたの順位★").appendTo(d);var j=$("<ul/>").addClass("ranking").appendTo(d),k=function(a,b){var c=$("<div/>");return c.addClass("grid name"),$("<img/>").attr("src",b).appendTo(c),$("<span>").text("@"+a).appendTo(c),c},l=$("<li/>");return $("<div/>").addClass("grid rank").addClass(this.setRankimg(g)).text(g).appendTo(l),k(e,f).appendTo(l),$("<div/>").addClass("grid-right count").text(h+" ("+i+")").appendTo(l),j.append(l),c},e.fn.createMessageAlert=function(){var a=this.createLayout(),b=a.find(".content"),c=$("<div/>").appendTo(b);return c.text("1位目指して頑張ってください♪"),a},e.fn.display=function(a){return $("body").append(a),a},e.fn.hidden=function(){$(".alert").remove()},e.fn.animate=function(a){var b=$.Deferred();return this.hidden(),this.display(a).css("display","none"),a.slideToggle("slow",function(){a.delay(1e3).slideToggle("slow",function(){b.resolve(),a.remove()})}),b};var f=function(){var a,b=PIXI.DisplayObjectContainer,c=function(a){this._Parent=b,b.apply(this),this.ballSize=42,this.name=a.name,this.id=a.id,this.img=a.picture,this.data={mask:null,sprite:null,crown:null},this._createSprite(a)};c.fn=c.prototype;for(a in b.prototype)c.fn[a]=b.prototype[a];return c}();f.fn._createTwitter=function(a){var b,d;try{b=c.getSprite(a.picture),d=this._createMask(),b.mask=d,this.addChild(b),this.addChild(d),this.data.mask=d,this.data.sprite=b,b.anchor.set(.5,.5)}catch(e){this._createGuest(a)}},f.fn._createGuest=function(a){var b=c.getSprite(a.texture);b.width=this.ballSize,b.height=this.ballSize,b.position.set(0,0),b.anchor.set(.5,.5),this.addChild(b),this.data.sprite=b},f.fn._createMask=function(){var a=new PIXI.Graphics;return a.position.set(0,0),a.beginFill(),a.drawCircle(0,0,this.ballSize/2),a.color=16777215,a.endFill(),a},f.fn._createSprite=function(a){switch(a.userType){case"guest":this._createGuest(a);break;default:this._createTwitter(a)}},f.fn.setCrown=function(a){var b=c.getSprite(a);b.position.set(0,-this.ballSize),b.anchor.set(.5,.5),this.data.crown=b,this.addChild(b)},f.fn.removeCrown=function(){var a=this.data.crown;a&&(this.removeChild(a),this.data.crown=void 0)},f.fn.updateCrown=function(a){a=window.parseInt(a,10),1===a?this.setCrown("/texture/icons/gold.png"):2===a?this.setCrown("/texture/icons/silver.png"):3===a?this.setCrown("/texture/icons/blonze.png"):this.removeCrown()};var g=function(a){this.textureURLs=a.textureURLs||["texture/field1.json","texture/kabe.json","texture/player.json","texture/message.json"],this.backgroundURL=a.backgroundURL||"texture/background/background.png",this.gameInfoURL=a.gameInfoURL||"game/gamedata.json",this.socketURL=a.socketURL||"//";var b=a.target||"body",c=$(b).width(),d=$(b).height();this.viewerSize={width:c,height:d},this.worldSize={width:c,height:d},this.timeInfo={current:"",best:"",bestPlayer:"",fps:0,nowDisplay:0},this.alert=new e,this.$el=$(a.target),this.el=this.$el.get(0),this.stage=new PIXI.Stage(16777215),this.renderer=new PIXI.autoDetectRenderer(c,d),this.player=null,this.fieldLayer=new PIXI.DisplayObjectContainer,this.fieldLayer.position.set(0,0),this.playerLayer=new PIXI.DisplayObjectContainer,this.playerLayer.position.set(0,0),this.playerLayer.hash={},this.objectLayer=new PIXI.DisplayObjectContainer,this.objectLayer.position.set(0,0),this.menuLayer=new PIXI.DisplayObjectContainer,this.menuLayer.position.set(0,0),this.stage.addChild(this.fieldLayer),this.stage.addChild(this.objectLayer),this.stage.addChild(this.playerLayer),this.stage.addChild(this.menuLayer),this._controller=null,this._socket=null,this.$el.append(this.renderer.view)};g.fn=g.prototype,g.fn.setAudio=function(a){var b={};return $(a).find(".audio-file").each(function(){var a=$(this).get(0),c=$(a).data().key;b[c]=new d(a)}),this.audio=b,this},g.getAgent=function(){var a="Android",b="iOS",c="Windows",d="Other",e=function(){var e=window.navigator.userAgent,f="";return f=-1!=e.search(/iPhone/)?b:-1!=e.search(/iPad/)?b:-1!=e.search(/Android/)?a:-1!=e.search(/Windows/)?c:d};return e.ios=b,e.android=a,e.windows=c,e.other=d,e}(),g.getGravityDirection=function(){var a=g.getAgent();switch(a){case g.getAgent.ios:return 1;case g.getAgent.android:return-1;case g.getAgent.windows:return-1;default:return 1}},g.checkDeviceMotion=function(){return"ondevicemotion"in window?!0:!1},g.scale=function(){var a={};a.domain=[0,1],a.range=[0,1];var b=function(b){var c=a.domain,d=a.range,e=(d[0]-d[1])/(c[0]-c[1]),f=d[0]-e*c[0];return e*b+f};return b.domain=function(c){return a.domain=c,b},b.range=function(c){return a.range=c,b},b},g.fn.loadTexture=function(){var a=this,b=$.Deferred(),c=new PIXI.AssetLoader(a.textureURLs);return c.onComplete=function(){a.onCompleteTexture(),b.resolve()},c.load(),b},g.fn.onCompleteTexture=function(){},g.fn.loadGameData=function(){var a=this,b=$.ajax({url:this.gameInfoURL}).done(function(b){a.onCompleteGameData(b)});return b},g.fn.onCompleteGameData=function(a){var b=a.world,d=b.width,e=b.height,f=(b.grid,this.fieldLayer);this.worldSize={width:d,height:e};var g=c.getSprite(this.backgroundURL);g.width=this.worldSize.width,g.height=this.worldSize.height,f.addChild(g)},g.fn.socketConnect=function(a){var b=$.Deferred(),c=this;return this._socket=io.connect(a),this._socket.on("connect",function(){b.resolve()}),this._socket.on("message",function(){c.onMessage.apply(c,arguments)}),this._socket.on("disconnect",function(){c.onDisconnected.apply(c,arguments)}),b},g.fn.onMessage=function(a){if(a){var b=this;a.value.forEach(function(a){var c=a.datatype||"object";switch(c){case"object":b.updateObject(a);break;case"you":b.updatePlayer(a);break;case"player":b.updatePlayer(a);break;case"ranking":b.congratulation(a);break;case"time":b.timeInfo.current=a.time;break;case"bestTime":b.timeInfo.best=a.time,b.timeInfo.bestPlayer=a.userName||"-"}})}},g.fn.onDisconnected=function(){window.alert("セッションが切れました。ログアウトします"),window.location.href="/logout/twitter"},g.fn.emit=function(a){var b=this.player||{},c=b.id;c&&(a.id=c,this._socket.emit("message",a))},g.fn.emitInfo=function(a){this._socket.emit("message",a)},g.fn.onController=function(){this._controller&&this.emit({gravity:this._controller.val})},g.fn.setDeviceMotion=function(a){"object"!=typeof a&&(a={}),a.x=a.x||0,a.y=a.y||0,this._controller.gravity=a},g.fn.setController=function(a,b){switch(a){case"touch":this._controller=new h(b);break;case"gravity":this._controller=new GravityController(b)}};var h=function(a){this.$el=$(a),this.el=this.$el.get(0),this.renderer=new PIXI.autoDetectRenderer(this.$el.width(),this.$el.height()),this.stage=new PIXI.Stage(14540253),this.$el.html(this.renderer.view),this.$canvas=this.$el.find("canvas"),this.$canvas.width(this.$el.width()).height(this.$el.height()),this.touchFlg=!1,this.marker=new PIXI.Graphics,this.marker.beginFill(),this.marker.drawCircle(0,0,10),this.marker.color=1118481,this.marker.endFill(),this.stage.addChild(this.marker),this.size={x:this.$canvas.width(),y:this.$canvas.height()},this.origin={x:this.$canvas.width()/2,y:this.$canvas.height()/2},this.range={cx:[-this.origin.x,this.origin.x],cy:[-this.origin.y,this.origin.y],vx:[-5,5],vy:[5,-5],scale:function(a){var b=this.cx,c=this.cy,d=this.vx,e=this.vy;return"x"===a?(b[1]-b[0])/(d[1]-d[0]):(c[1]-c[0])/(e[1]-e[0])}},this.offset={x:this.origin.x,y:this.origin.y,_size:this.size,set:function(a,b){return this.x=this._size.x<a?this._size.x:a,this.x=this.x<0?0:this.x,this.y=this._size.y<b?this._size.y:b,this.y=this.y<0?0:this.y,this}},this.val={x:0,y:0,set:function(a,b){return this.x=a,this.y=b,this}},this.setEvent(),this.animate()};h.fn=h.prototype,a.TouchController=h,h.fn.onTouchStart=function(a){a.preventDefault(),this.touchFlg=!0},h.fn.onTouchEnd=function(a){a.preventDefault(),this.touchFlg=!1,this.clear()},h.fn.onTouch=function(a){if(this.touchFlg){a.preventDefault();var b=this.$canvas.get(0).getBoundingClientRect(),c=a.originalEvent.changedTouches,d=c?c[0]:a.originalEvent,e=d.clientX-b.left,f=d.clientY-b.top;this.offset.set(e,f);var g=this.offset.x-this.origin.x,h=this.offset.y-this.origin.y;this.val.set(g/this.range.scale("x"),h/this.range.scale("y"))}},h.fn.setEvent=function(){var a=this;this.$canvas.on("touchstart",$.proxy(this.onTouchStart,this)),this.$canvas.on("touchend",$.proxy(this.onTouchEnd,this)),this.$canvas.on("touchmove",$.proxy(this.onTouch,this)),this.$canvas.on("mousedown",function(){a.onTouchStart.apply(a,arguments);$(window).one("mouseup",function(){a.onTouchEnd.apply(a,arguments)})}),$(window).on("mousemove",$.proxy(this.onTouch,this))},h.fn.clear=function(){this.val.set(0,0),this.offset.set(this.origin.x,this.origin.y)},h.fn.display=function(){{var a=this.offset;this.size,this.marker.radius,this.marker.color}this.marker.position.set(a.x,a.y)},h.fn.animate=function(){var a=this;this.display(),this.renderer.render(this.stage),window.requestAnimFrame(function(){a.animate()})},GravityController=function(a){this.val={x:0,y:0,set:function(a,b){return this.x=a,this.y=b,this}},this.direction=a,this.setEvent()},GravityController.fn=GravityController.prototype,GravityController.fn.setEvent=function(){var a=this;$(window).on("devicemotion",function(){var b=event.accelerationIncludingGravity.x||0,c=event.accelerationIncludingGravity.y||0;a.val.set(b*a.direction,c*a.direction)})},g.fn.removePlayer=function(a){var b=this.playerLayer.hash[a];return b?(this.playerLayer.removeChild(b),delete this.playerLayer.hash[a],this.player===b&&delete this.player,this):this},g.fn.updatePlayer=function(a){var b=this.playerLayer,c=null;return a.delflag?(this.removePlayer(a.id),null):(b.hash[a.id]?c=b.hash[a.id]:(c=new f(a),b.addChild(c)),b.hash[a.id]=c,c.data.sprite.rotation=window.parseFloat(a.angle,10),c.position.set(window.parseFloat(a.x,10),window.parseFloat(a.y,10)),"you"===a.datatype&&(this.player=c),c)},g.fn.removeObject=function(a){var b=this.objectLayer.children.filter(function(b){return b.id===a});if(!b.length)return this;var c=b[0];return this.objectLayer.removeChild(c),this},g.fn.updateObject=function(a){var b,d=a.id,e={x:window.parseFloat(a.x,10),y:window.parseFloat(a.y,10)},f=a.texture,g=(a.datatype||"object",window.parseFloat(a.angle,10)),h=this.objectLayer,i=[];return a.delflag?(this.removeObject(a.id),null):(i=h.children.filter(function(a){return a.id===d}),i.length?b=i[0]:(b=c.getSprite(f),b.id=d,h.addChild(b)),b.position.set(e.x,e.y),b.anchor.set(.5,.5),b.rotation=g,b)},g.fn.rescale=function(){var a=$(".game-display").width(),b=$(".game-display").height(),c=this.worldSize.width,d=this.worldSize.height,e={x:1,y:1},f={x:1,y:1},g=1;b/d>a/c?(e.x=a*g,e.y=e.x/c*d):(e.y=b*g,e.x=e.y/d*c),f.x=e.x/this.worldSize.width,f.y=e.y/this.worldSize.height,this.renderer.resize(e.x,e.y),this.playerLayer.scale.set(f.x,f.y),this.fieldLayer.scale.set(f.x,f.y),this.objectLayer.scale.set(f.x,f.y),this.menuLayer.scale.set(f.x,f.y)},g.fn.animate=function(){var a=this;$("#current-time .timescore").text(this.timeInfo.current),$("#best-time .timescore").text(this.timeInfo.nowDisplay?this.timeInfo.best:this.timeInfo.bestPlayer),this.timeInfo.fps>180?(this.timeInfo.nowDisplay=!this.timeInfo.nowDisplay,this.timeInfo.fps=0):this.timeInfo.fps++,this.renderer.render(this.stage),window.requestAnimFrame(function(){a.animate(a)})},g.fn.congratulation=function(a){var b,c,d,e,f,g,h,i=this.playerLayer.hash,j=i[a.win_id],k=[],l={},m=$.Deferred(),n=this;for(b=0,c=a.data.length;c>b;b++)d=a.data[b],k.length<3&&k.push({rank:b+1,data:d,sprite:i[d.id]}),this.player.id===d.id&&(l={rank:b+1,data:d,sprite:this.player}),i[d.id].updateCrown(b+1);e=this.alert.createGoalAlert(j),f=this.alert.createRankingAlert(k),g=this.alert.createYourRankAlert(l,k[0].data.win),h=this.alert.createMessageAlert(),m.then(function(){return n.alert.animate(e)}).then(function(){return n.alert.animate(f)}).then(function(){return n.alert.animate(g)}).then(function(){return n.alert.animate(h)}),m.resolve()},g.fn.start=function(){var a=this,b=a.loadTexture();return b.then(function(){return a.loadGameData()})},a.Game=g,"function"==typeof define&&define.amd?define(b,a):"object"==typeof module&&module.exports?module.exports=a:this[b]=a}({});